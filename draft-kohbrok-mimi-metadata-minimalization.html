<!DOCTYPE html>
<html lang="en" class="Internet-Draft">
<head>
<meta charset="utf-8">
<meta content="Common,Latin" name="scripts">
<meta content="initial-scale=1.0" name="viewport">
<title>MIMI Metadata Minimalization (MIMIMI)</title>
<meta content="Konrad Kohbrok" name="author">
<meta content="Raphael Robert" name="author">
<meta content="
       This document describes a proposal to run the MIMI protocol in a way that
reduces the ability of the Hub and service providers to associate messaging
activity of clients with their respective identities. 
       For now, this document only contains a high-level description of the mechanisms
involved. 
    " name="description">
<meta content="xml2rfc 3.23.1" name="generator">
<meta content="Internet-Draft" name="keyword">
<meta content="draft-kohbrok-mimi-metadata-minimalization-latest" name="ietf.draft">
<!-- Generator version information:
  xml2rfc 3.23.1
    Python 3.12.6
    ConfigArgParse 1.7
    google-i18n-address 3.1.1
    intervaltree 3.1.0
    Jinja2 3.1.4
    lxml 4.9.4
    platformdirs 4.3.6
    pycountry 22.3.5
    PyYAML 6.0.1
    requests 2.32.3
    setuptools 70.3.0
    wcwidth 0.2.13
-->
<link href="draft-kohbrok-mimi-metadata-minimalization.xml" rel="alternate" type="application/rfc+xml">
<link href="#copyright" rel="license">
<style type="text/css">@font-face {
  font-family: 'Lora';
  font-style: italic;
  font-weight: 400;
  font-display: swap;
  src: local('Lora Italic'), local('Lora-Italic'), url('https://martinthomson.github.io/rfc-css/fonts/lora-italic-cyrillic-ext.woff2') format('woff2');
  unicode-range: U+0460-052F, U+1C80-1C88, U+20B4, U+2DE0-2DFF, U+A640-A69F, U+FE2E-FE2F;
}
@font-face {
  font-family: 'Lora';
  font-style: italic;
  font-weight: 400;
  font-display: swap;
  src: local('Lora Italic'), local('Lora-Italic'), url('https://martinthomson.github.io/rfc-css/fonts/lora-italic-cyrillic-ext.woff2') format('woff2');
  unicode-range: U+0400-045F, U+0490-0491, U+04B0-04B1, U+2116;
}
@font-face {
  font-family: 'Lora';
  font-style: italic;
  font-weight: 400;
  font-display: swap;
  src: local('Lora Italic'), local('Lora-Italic'), url('https://martinthomson.github.io/rfc-css/fonts/lora-italic-vietnamese.woff2') format('woff2');
  unicode-range: U+0102-0103, U+0110-0111, U+1EA0-1EF9, U+20AB;
}
@font-face {
  font-family: 'Lora';
  font-style: italic;
  font-weight: 400;
  font-display: swap;
  src: local('Lora Italic'), local('Lora-Italic'), url('https://martinthomson.github.io/rfc-css/fonts/lora-italic-latin-ext.woff2') format('woff2');
  unicode-range: U+0100-024F, U+0259, U+1E00-1EFF, U+2020, U+20A0-20AB, U+20AD-20CF, U+2113, U+2C60-2C7F, U+A720-A7FF;
}

@font-face {
  font-family: 'Lora';
  font-style: italic;
  font-weight: 400;
  font-display: swap;
  src: local('Lora Italic'), local('Lora-Italic'), url('https://martinthomson.github.io/rfc-css/fonts/lora-italic-latin.woff2') format('woff2');
  unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02BB-02BC, U+02C6, U+02DA, U+02DC, U+2000-206F, U+2074, U+20AC, U+2122, U+2191, U+2193, U+2212, U+2215, U+FEFF, U+FFFD;
}
@font-face {
  font-family: 'Lora';
  font-style: normal;
  font-weight: 400;
  font-display: swap;
  src: local('Lora Regular'), local('Lora-Regular'), url('https://martinthomson.github.io/rfc-css/fonts/lora-regular-cyrillic-ext.woff2') format('woff2');
  unicode-range: U+0460-052F, U+1C80-1C88, U+20B4, U+2DE0-2DFF, U+A640-A69F, U+FE2E-FE2F;
}
@font-face {
  font-family: 'Lora';
  font-style: normal;
  font-weight: 400;
  font-display: swap;
  src: local('Lora Regular'), local('Lora-Regular'), url('https://martinthomson.github.io/rfc-css/fonts/lora-regular-cyrillic.woff2') format('woff2');
  unicode-range: U+0400-045F, U+0490-0491, U+04B0-04B1, U+2116;
}
@font-face {
  font-family: 'Lora';
  font-style: normal;
  font-weight: 400;
  font-display: swap;
  src: local('Lora Regular'), local('Lora-Regular'), url('https://martinthomson.github.io/rfc-css/fonts/lora-regular-vietnamese.woff2') format('woff2');
  unicode-range: U+0102-0103, U+0110-0111, U+1EA0-1EF9, U+20AB;
}
@font-face {
  font-family: 'Lora';
  font-style: normal;
  font-weight: 400;
  font-display: swap;
  src: local('Lora Regular'), local('Lora-Regular'), url('https://martinthomson.github.io/rfc-css/fonts/lora-regular-latin-ext.woff2') format('woff2');
  unicode-range: U+0100-024F, U+0259, U+1E00-1EFF, U+2020, U+20A0-20AB, U+20AD-20CF, U+2113, U+2C60-2C7F, U+A720-A7FF;
}
@font-face {
  font-family: 'Lora';
  font-style: normal;
  font-weight: 400;
  font-display: swap;
  src: local('Lora Regular'), local('Lora-Regular'), url('https://martinthomson.github.io/rfc-css/fonts/lora-regular-latin.woff2') format('woff2');
  unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02BB-02BC, U+02C6, U+02DA, U+02DC, U+2000-206F, U+2074, U+20AC, U+2122, U+2191, U+2193, U+2212, U+2215, U+FEFF, U+FFFD;
}

@font-face {
  font-family: 'Lora';
  font-style: normal;
  font-weight: 700;
  font-display: swap;
  src: local('Lora Bold'), local('Lora-Bold'), url('https://martinthomson.github.io/rfc-css/fonts/lora-bold-cyrillic-ext.woff2') format('woff2');
  unicode-range: U+0460-052F, U+1C80-1C88, U+20B4, U+2DE0-2DFF, U+A640-A69F, U+FE2E-FE2F;
}
@font-face {
  font-family: 'Lora';
  font-style: normal;
  font-weight: 700;
  font-display: swap;
  src: local('Lora Bold'), local('Lora-Bold'), url('https://martinthomson.github.io/rfc-css/fonts/lora-bold-cyrillic.woff2') format('woff2');
  unicode-range: U+0400-045F, U+0490-0491, U+04B0-04B1, U+2116;
}
@font-face {
  font-family: 'Lora';
  font-style: normal;
  font-weight: 700;
  font-display: swap;
  src: local('Lora Bold'), local('Lora-Bold'), url('https://martinthomson.github.io/rfc-css/fonts/lora-bold-vietnamese.woff2') format('woff2');
  unicode-range: U+0102-0103, U+0110-0111, U+1EA0-1EF9, U+20AB;
}
@font-face {
  font-family: 'Lora';
  font-style: normal;
  font-weight: 700;
  font-display: swap;
  src: local('Lora Bold'), local('Lora-Bold'), url('https://martinthomson.github.io/rfc-css/fonts/lora-bold-latin-ext.woff2') format('woff2');
  unicode-range: U+0100-024F, U+0259, U+1E00-1EFF, U+2020, U+20A0-20AB, U+20AD-20CF, U+2113, U+2C60-2C7F, U+A720-A7FF;
}
@font-face {
  font-family: 'Lora';
  font-style: normal;
  font-weight: 700;
  font-display: swap;
  src: local('Lora Bold'), local('Lora-Bold'), url('https://martinthomson.github.io/rfc-css/fonts/lora-bold-latin.woff2') format('woff2');
  unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02BB-02BC, U+02C6, U+02DA, U+02DC, U+2000-206F, U+2074, U+20AC, U+2122, U+2191, U+2193, U+2212, U+2215, U+FEFF, U+FFFD;
}
@font-face {
  font-family: 'Lora';
  font-style: normal;
  font-weight: 600;
  font-display: swap;
  src: local('Lora SemiBold'), local('Lora-SemiBold'), url('https://martinthomson.github.io/rfc-css/fonts/lora-semibold-latin.woff2') format('woff2');
  unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02BB-02BC, U+02C6, U+02DA, U+02DC, U+2000-206F, U+2074, U+20AC, U+2122, U+2191, U+2193, U+2212, U+2215, U+FEFF, U+FFFD;
}

@font-face {
  font-family: 'Cabin Condensed';
  font-style: normal;
  font-weight: 600;
  font-display: swap;
  src: local('Cabin Condensed SemiBold'), local('CabinCondensed-SemiBold'), url('https://martinthomson.github.io/rfc-css/fonts/cabincondensed-semibold-vietnamese.woff2') format('woff2');
  unicode-range: U+0102-0103, U+0110-0111, U+1EA0-1EF9, U+20AB;
}
@font-face {
  font-family: 'Cabin Condensed';
  font-style: normal;
  font-weight: 600;
  font-display: swap;
  src: local('Cabin Condensed SemiBold'), local('CabinCondensed-SemiBold'), url('https://martinthomson.github.io/rfc-css/fonts/cabincondensed-semibold-latin-ext.woff2') format('woff2');
  unicode-range: U+0100-024F, U+0259, U+1E00-1EFF, U+2020, U+20A0-20AB, U+20AD-20CF, U+2113, U+2C60-2C7F, U+A720-A7FF;
}
@font-face {
  font-family: 'Cabin Condensed';
  font-style: normal;
  font-weight: 600;
  font-display: swap;
  src: local('Cabin Condensed SemiBold'), local('CabinCondensed-SemiBold'), url('https://martinthomson.github.io/rfc-css/fonts/cabincondensed-semibold-latin.woff2') format('woff2');
  unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02BB-02BC, U+02C6, U+02DA, U+02DC, U+2000-206F, U+2074, U+20AC, U+2122, U+2191, U+2193, U+2212, U+2215, U+FEFF, U+FFFD;
}

@font-face {
  font-family: 'Oxygen Mono';
  font-style: normal;
  font-weight: 400;
  font-display: swap;
  src: local('Oxygen Mono'), local('OxygenMono-Regular'), url('https://martinthomson.github.io/rfc-css/fonts/oxygenmono-regular-latin-ext.woff2') format('woff2');
  unicode-range: U+0100-024F, U+0259, U+1E00-1EFF, U+2020, U+20A0-20AB, U+20AD-20CF, U+2113, U+2C60-2C7F, U+A720-A7FF;
}
@font-face {
  font-family: 'Oxygen Mono';
  font-style: normal;
  font-weight: 400;
  font-display: swap;
  src: local('Oxygen Mono'), local('OxygenMono-Regular'), url('https://martinthomson.github.io/rfc-css/fonts/oxygenmono-regular-latin.woff2') format('woff2');
  unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02BB-02BC, U+02C6, U+02DA, U+02DC, U+2000-206F, U+2074, U+20AC, U+2122, U+2191, U+2193, U+2212, U+2215, U+FEFF, U+FFFD;
}

:root {
  color-scheme: light dark;
  --background-color: #fff;
  --text-color: #222;
  --title-color: #191919;
  --link-color: #2a6496;
  --highlight-color: #f9f9f9;
  --line-color: #eee;
  --pilcrow-weak: #ddd;
  --pilcrow-strong: #bbb;
  --small-font-size: 14.5px;
  --font-mono: 'Oxygen Mono', monospace;
  scrollbar-color: #bbb #eee;
}
body {
  max-width: 600px;
  margin: 75px auto;
  padding: 0 5px;
  color: var(--text-color);
  background-color: var(--background-color);
  font: 16px/22px "Lora", serif;
  scroll-behavior: smooth;
}

.ears {
  display: none;
}

/* headings */
h1, h2, h3, h4, h5, h6 {
  font-family: "Cabin Condensed", sans-serif;
  font-weight: 600;
  margin: 0.8em 0 0.3em;
  font-size-adjust: 0.5;
  color: var(--title-color);
}
h1#title {
  font-size: 32px;
  line-height: 40px;
  clear: both;
}
h1#title, h1#rfcnum {
  margin: 1.5em 0 0.2em;
}
h1#rfcnum + h1#title {
  margin: 0.2em 0;
}

h1, h2, h3 {
  font-size: 22px;
  line-height: 27px;
}
h4, h5, h6 {
  font-size: 20px;
  line-height: 24px;
}

/* general structure */
.author {
  padding-bottom: 0.3em;
}
#abstract+p {
  font-size: 18px;
  line-height: 24px;
}
#abstract+p code, #abstract+p samp, #abstract+p tt {
  font-size: 16px;
  line-height: 0;
}

p {
  padding: 0;
  margin: 0.5em 0;
  text-align: left;
}
div {
  margin: 0;
}
.alignRight.art-text {
  background-color: var(--highlight-color);
  border: 1px solid var(--line-color);
  border-radius: 3px;
  padding: 0.5em 1em 0;
  margin-bottom: 0.5em;
}
.alignRight.art-text pre {
  padding: 0;
  width: auto;
}
.alignRight {
  margin: 1em 0;
}
.alignRight > *:first-child {
  border: none;
  margin: 0;
  float: right;
  clear: both;
}
.alignRight > *:nth-child(2) {
  clear: both;
  display: block;
  border: none;
}
svg {
  display: block;
}
/* font-family isn't space-separated, but =~ will have to do */
svg[font-family~="monospace" i], svg [font-family~="monospace" i] {
  font-family: var(--font-mono);
}
.alignCenter.art-text {
  background-color: var(--highlight-color);
  border: 1px solid var(--line-color);
  border-radius: 3px;
  padding: 0.5em 1em 0;
  margin-bottom: 0.5em;
}
.alignCenter.art-text pre {
  padding: 0;
  width: auto;
}
.alignCenter {
  margin: 1em 0;
}
.alignCenter > *:first-child {
  border: none;
  /* this isn't optimal, but it's an existence proof.  PrinceXML doesn't
     support flexbox yet.
  */
  display: table;
  margin: 0 auto;
}

/* lists */
ol, ul {
  padding: 0;
  margin: 0 0 0.5em 2em;
}
:is(ol, ul) :is(ol, ul) {
  margin-left: 1em;
}
li {
  margin: 0 0 0.25em 0;
}
.ulCompact li {
  margin: 0;
}
ul.empty, .ulEmpty {
  list-style-type: none;
}
ul.empty li, .ulEmpty li {
  margin-top: 0.5em;
}
:is(ul, ol).compact, .ulCompact, .olCompact {
  line-height: 1;
  margin: 0 0 0 2em;
}

/* definition lists */
dl {
  clear: left;
  --indent: 3ch;
  /* --indent: attr(indent ch); not supported in any browser, but we can dream */
}
dl.olPercent {
  --indent: 5ch;
}
dl > dt {
  float: left;
  margin-right: 2ch;
  min-width: 8ch;
}
dl.dlNewline > dt {
  float: none;
}
dl > dd {
  margin-bottom: .8em;
  margin-left: var(--indent) !important; /* stupid element overrides */
  min-height: 2ex;
}
dl.olPercent > dt {
  min-width: calc(var(--indent) - 2ch);
}
:is(dl.compact, .dlCompact) > dd {
  margin-bottom: 0;
}
:is(dl.compact, .dlCompact) > dd > :is(:first-child, .break:first-child + *) {
  margin-top: 0;
}
:is(dl.compact, .dlCompact) > dd > :is(:last-child) {
  margin-bottom: 0;
}
dl > dd > dl {
  margin-top: 0.5em;
  margin-bottom: 0;
}
:is(dd, span).break {
  display: none;
}

/* links */
a, a[href].selfRef:hover {
  text-decoration: none;
}
a[href] {
  color: var(--link-color);
}
a[href].selfRef, .iref + a[href].internal {
  color: var(--text-color);
}
a[href]:hover {
  text-decoration: underline;
}
a[href].selfRef:hover {
  background-color: var(--highlight-color);
}
a.xref:is(.cite, .auto), :is(#status-of-memo, #copyright) a {
  white-space: nowrap;
}

/* Figures */
tt, code, pre {
  background-color: var(--highlight-color);
  font: 14px/22px var(--font-mono);
}
tt, code {
  /* changing the font for inline elements leads to different ascender
     and descender heights; as we want to retain baseline alignment,
     remove leading to avoid altering the final height of lines
     note: this fails if these blocks take an entire line,
     a different solution would be great */
  line-height: 0;
}
:is(h1, h2, h3, h4, h5, h6) :is(tt, code) {
  font-size: 84%;
}
pre {
  border: 1px solid var(--line-color);
  font-size: 13.5px;
  line-height: 16px;
  letter-spacing: -0.2px;
  margin: 5px;
  padding: 5px;
}
img {
  max-width: 100%;
}
figure {
  margin: 0.5em 0;
  padding: 0;
}
figure blockquote {
  margin: 0.8em 0.4em 0.4em;
}
figcaption, caption {
  font-style: italic;
  margin: 0.5em 1.5em;
  text-align: left;
}
@media screen {
  /* Auto-collapse boilerplate. */
  :is(#status-of-memo, #copyright) p {
    margin: -2px 0;
    max-height: 0;
    transition: max-height 2s ease, margin 0.5s ease 0.5s;
    overflow: hidden;
  }
  :is(#status-of-memo, #copyright):hover p,
  :is(#status-of-memo, #copyright) h2:target ~ p {
    margin: 0.5em 0;
    max-height: 500px;
    overflow: auto;
  }
  pre, svg {
    display: inline-block;
    overflow-x: auto;
  }
  pre {
    max-width: 100%;
    width: calc(100% - 22px - 1em);
  }
  svg {
    max-width: calc(100% - 22px - 1em);
  }
  figure pre {
    display: block;
    width: calc(100% - 25px);
  }
  :is(pre, svg) + .pilcrow {
    display: inline-block;
    vertical-align: text-bottom;
    padding-bottom: 8px;
  }
}

/* aside, blockquote */
aside, blockquote {
  margin-left: 0;
  padding: 0 2em;
  font-style: italic;
}
blockquote {
  margin: 1em 0;
}
cite {
  display: block;
  text-align: right;
  font-style: italic;
}

/* tables */
table {
  max-width: 100%;
  margin: 0 0 1em;
  border-collapse: collapse;
}
table.right {
  margin-left: auto;
}
table.center {
  margin-left: auto;
  margin-right: auto;
}
table.left {
  margin-right: auto;
}
thead, tbody {
  border: 1px solid var(--line-color);
}
th, td {
  text-align: left;
  vertical-align: top;
  padding: 5px 10px;
}
th {
  background-color: var(--line-color);
}
:is(tr:nth-child(2n), thead+tbody > tr:nth-child(2n+1)) > td {
  background-color: var(--background-color);
}
:is(tr:nth-child(2n+1), thead+tbody > tr:nth-child(2n)) > td {
  background-color: var(--highlight-color);
}
table caption {
  margin: 0;
  padding: 3px 0 3px 1em;
}
table p {
  margin: 0;
}

/* pilcrow */
a.pilcrow {
  margin-left: 3px;
  opacity: 0.2;
  user-select: none;
}
a.pilcrow[href] { color: var(--pilcrow-weak); }
a.pilcrow[href]:hover { text-decoration: none; }
@media not print {
  :hover > a.pilcrow {
    opacity: 1;
  }
  a.pilcrow[href]:hover {
    color: var(--pilcrow-strong);
    background-color: transparent;
  }
}
@media print {
  a.pilcrow {
    display: none;
  }
}

/* misc */
hr {
  border: 0;
  border-top: 1px solid var(--line-color);
}
.bcp14 {
  font-variant: small-caps;
  font-weight: 600;
  font-size: var(--small-font-size);
}
.role {
  font-variant: all-small-caps;
}
sub, sup {
  line-height: 1;
  font-size: 80%;
}

/* info block */
#identifiers {
  margin: 0;
  font-size: var(--small-font-size);
  line-height: 18px;
  --identifier-width: 15ch;
}
#identifiers dt {
  width: var(--identifier-width);
  min-width: var(--identifier-width);
  clear: left;
  float: left;
  text-align: right;
  margin-right: 1ch;
}
#identifiers dd {
  margin: 0;
  margin-left: calc(1em + var(--identifier-width)) !important;
  min-width: 5em;
}
#identifiers .authors .author {
  display: inline-block;
  margin-right: 1.5em;
}
#identifiers .authors .org {
  font-style: italic;
}

/* The prepared/rendered info at the very bottom of the page */
.docInfo {
  color: #999;
  font-size: 0.9em;
  font-style: italic;
  margin-top: 2em;
}
.docInfo .prepared {
  float: left;
}
.docInfo .prepared {
  float: right;
}

/* table of contents */
#toc {
  padding: 0.75em 0 2em 0;
  margin-bottom: 1em;
}
#toc nav ul {
  margin: 0 0.5em 0 0;
  padding: 0;
  list-style: none;
}
#toc nav li {
  line-height: 1.3em;
  margin: 2px 0;
  padding-left: 1.2em;
  text-indent: -1.2em;
}
#toc a.xref {
  white-space: normal;
}
/* references */
.references dt {
  text-align: right;
  font-weight: bold;
  min-width: 10ch;
  margin-right: 1.5ch;
}
.references dt:target::before {
  content: "⇒";
  width: 15px;
  margin: 0 10px 0 -25px;
}
.references dd {
  margin-left: 12ch !important;
  overflow: auto;
}

.refInstance {
  margin-bottom: 1.25em;
}

.references .ascii {
  margin-bottom: 0.25em;
}

/* index */
#rfc\.index\.index + ul {
  margin-left: 0;
}

/* authors */
address.vcard {
  font-style: normal;
  margin: 1em 0;
}
address.vcard .nameRole {
  font-weight: 700;
  margin-left: 0;
}
address.vcard .label {
  margin: 0.5em 0;
}
address.vcard .type {
  display: none;
}
.alternative-contact {
  margin: 1.5em 0 1em;
}
hr.addr {
  border-top: 1px dashed;
  margin: 0;
  color: #ddd;
  max-width: calc(100% - 16px);
}
@media (min-width: 500px) {
  #authors-addresses > section {
    column-count: 2;
    column-gap: 20px;
  }
  #authors-addresses > section > h2 {
    column-span: all;
  }
  /* hack for break-inside: avoid-column */
  #authors-addresses address {
    display: inline-block;
    break-inside: avoid-column;
  }
}

.rfcEditorRemove p:first-of-type {
  font-style: italic;
}
.cref {
  background-color: rgba(249, 232, 105, 0.3);
  padding: 2px 4px;
}
.crefSource {
  font-style: italic;
}
/* alternative layout for smaller screens */
@media screen and (max-width: 929px) {
  #toc {
    position: fixed;
    z-index: 2;
    top: 0;
    right: 0;
    padding: 1px 0 0 0;
    margin: 0;
    border-bottom: 1px solid #ccc;
    opacity: 0.6;
  }
  #toc.active {
      opacity: 1;
  }
  #toc h2 {
    margin: 0;
    padding: 2px 0 2px 6px;
    padding-right: 1em;
    font-size: 18px;
    line-height: 24px;
    min-width: 190px;
    text-align: right;
    background-color: #444;
    color: white;
    cursor: pointer;
  }
  #toc h2::before { /* css hamburger */
    float: right;
    position: relative;
    width: 1em;
    height: 1px;
    left: -164px;
    margin: 8px 0 0 0;
    background: white none repeat scroll 0 0;
    box-shadow: 0 4px 0 0 white, 0 8px 0 0 white;
    content: "";
  }
  #toc nav {
    display: none;
    background-color: var(--background-color);
    padding: 0.5em 1em 1em;
    overflow: auto;
    overscroll-behavior: contain;
    height: calc(100vh - 48px);
    border-left: 1px solid #ddd;
  }
  #toc.active nav {
    display: block;
  }
  /* Make the collapsed ToC header render white on gray also when it's a link */
  #toc h2 a,
  #toc h2 a:link,
  #toc h2 a:focus,
  #toc h2 a:hover,
  #toc a.toplink,
  #toc a.toplink:hover {
    color: white;
    background-color: #444;
    text-decoration: none;
  }
  #toc a.toplink {
    margin-top: 2px;
  }
}

/* alternative layout for wide screens */
@media screen and (min-width: 930px) {
  body {
    padding-right: 360px;
    padding-right: calc(min(180px + 20%, 500px));
  }
  #toc {
    position: fixed;
    bottom: 0;
    right: 0;
    right: calc(50vw - 480px);
    width: 312px;
    margin: 0;
    padding: 0;
    z-index: 1;
  }
  #toc h2 {
    margin: 0;
    padding: 0.25em 1em 1em 0;
  }
  #toc nav {
    display: block;
    height: calc(90vh - 84px);
    bottom: 0;
    padding: 0.5em 0 2em;
    overflow: auto;
    overscroll-behavior: contain;
    scrollbar-width: thin;
  }
  #toc nav > ul  {
    margin-bottom: 2em;
  }
  #toc ul {
    margin: 0 0 0 4px;
    font-size: var(--small-font-size);
  }
  #toc ul :is(p, li) {
    margin: 2px 0;
    line-height: 22px;
  }
  img { /* future proofing */
    max-width: 100%;
    height: auto;
  }
}

/* pagination */
@media print {
  body {
    width: 100%;
  }
  p {
    orphans: 3;
    widows: 3;
  }
  #n-copyright-notice {
    border-bottom: none;
  }
  #toc, #n-introduction {
    page-break-before: always;
  }
  #toc {
    border-top: none;
    padding-top: 0;
  }
  figure, pre, .vcard {
    page-break-inside: avoid;
  }
  h1, h2, h3, h4, h5, h6 {
    page-break-after: avoid;
  }
  :is(h2, h3, h4, h5, h6)+*, dd {
    page-break-before: avoid;
  }
  pre {
    white-space: pre-wrap;
    word-wrap: break-word;
    font-size: 10pt;
  }
  table {
    border: 1px solid #ddd;
  }
  td {
    border-top: 1px solid #ddd;
  }
  .toplink {
    display: none;
  }
}

@page :first {
  padding-top: 0;
  @top-left {
    content: normal;
    border: none;
  }
  @top-center {
    content: normal;
    border: none;
  }
  @top-right {
    content: normal;
    border: none;
  }
}

@page {
  size: A4;
  margin-bottom: 45mm;
  padding-top: 20px;
}

/* Changes introduced to fix issues found during implementation */

/* Separate body from document info even without intervening H1 */
section {
  clear: both;
}

/* Top align author divs, to avoid names without organization dropping level with org names */
.author {
  vertical-align: top;
}

/* Style section numbers with more space between number and title */
.section-number {
  padding-right: 0.5em;
}

/* Add styling for a link in the ToC that points to the top of the document */
a.toplink {
  float: right;
  margin: 8px 0.5em 0;
}

/* Provide styling for table cell text alignment */
table .text-left {
  text-align: left;
}
table .text-center {
  text-align: center;
}
table .text-right {
  text-align: right;
}

/* Make the alternative author contact information look less like just another
   author, and group it closer with the primary author contact information */
.alternative-contact {
  margin: 0.5em 0 0.25em 0;
}
address .non-ascii {
  margin: 0 0 0 2em;
}

/* With it being possible to set tables with alignment
  left, center, and right, { width: 100%; } does not make sense */
table {
  width: auto;
}

/* Avoid reference text that sits in a block with very wide left margin,
   because of a long floating dt label.*/
.references dd {
  overflow: visible;
}

/* Control caption placement */
caption {
  caption-side: bottom;
}

/* Limit the width of the author address vcard, so names in right-to-left
   script don't end up on the other side of the page. */

address.vcard {
  max-width: 20em;
  margin-right: auto;
}

/* For address alignment dependent on LTR or RTL scripts */
address div.left {
  text-align: left;
}
address div.right {
  text-align: right;
}

/* Dark mode. */
@media (prefers-color-scheme: dark) {
:root {
  --background-color: #121212;
  --text-color: #f0f0f0;
  --title-color: #fff;
  --link-color: #4da4f0;
  --highlight-color: #282828;
  --line-color: #444;
  --pilcrow-weak: #444;
  --pilcrow-strong: #666;
  scrollbar-color: #777 #333;
}
}

/* SVG Trick: a prefix match works because only black and white are allowed */
svg :is([stroke="black"], [stroke^="#000"]) {
  stroke: var(--text-color);
}
svg :is([stroke="white"], [stroke^="#fff"]) {
  stroke: var(--background-color);
}
svg :is([fill="black"], [fill^="#000"], :not([fill])) {
  fill: var(--text-color);
}
svg :is([fill="white"], [fill^="#fff"]) {
  fill: var(--background-color);
}
</style>

</head>
<body class="xml2rfc">
<table class="ears">
<thead><tr>
<td class="left">Internet-Draft</td>
<td class="center">MIMIMI</td>
<td class="right">September 2024</td>
</tr></thead>
<tfoot><tr>
<td class="left">Kohbrok &amp; Robert</td>
<td class="center">Expires 28 March 2025</td>
<td class="right">[Page]</td>
</tr></tfoot>
</table>
<div id="external-metadata" class="document-information"></div>
<div id="internal-metadata" class="document-information">
<dl id="identifiers">
<dt class="label-workgroup">Workgroup:</dt>
<dd class="workgroup">Network Working Group</dd>
<dt class="label-internet-draft">Internet-Draft:</dt>
<dd class="internet-draft">draft-kohbrok-mimi-metadata-minimalization-latest</dd>
<dt class="label-published">Published:</dt>
<dd class="published">
<time datetime="2024-09-24" class="published">24 September 2024</time>
    </dd>
<dt class="label-intended-status">Intended Status:</dt>
<dd class="intended-status">Informational</dd>
<dt class="label-expires">Expires:</dt>
<dd class="expires"><time datetime="2025-03-28">28 March 2025</time></dd>
<dt class="label-authors">Authors:</dt>
<dd class="authors">
<div class="author">
      <div class="author-name">K. Kohbrok</div>
<div class="org">Phoenix R&amp;D</div>
</div>
<div class="author">
      <div class="author-name">R. Robert</div>
<div class="org">Phoenix R&amp;D</div>
</div>
</dd>
</dl>
</div>
<h1 id="title">MIMI Metadata Minimalization (MIMIMI)</h1>
<section id="section-abstract">
      <h2 id="abstract"><a href="#abstract" class="selfRef">Abstract</a></h2>
<p id="section-abstract-1">This document describes a proposal to run the MIMI protocol in a way that
reduces the ability of the Hub and service providers to associate messaging
activity of clients with their respective identities.<a href="#section-abstract-1" class="pilcrow">¶</a></p>
<p id="section-abstract-2">For now, this document only contains a high-level description of the mechanisms
involved.<a href="#section-abstract-2" class="pilcrow">¶</a></p>
</section>
<section class="note rfcEditorRemove" id="section-note.1">
      <h2 id="name-discussion-venues">
<a href="#name-discussion-venues" class="section-name selfRef">Discussion Venues</a>
      </h2>
<p id="section-note.1-1">This note is to be removed before publishing as an RFC.<a href="#section-note.1-1" class="pilcrow">¶</a></p>
<p id="section-note.1-2">Discussion of this document takes place on the
    More Instant Messaging Interoperability Working Group mailing list (mimi@ietf.org),
    which is archived at <span><a href="https://mailarchive.ietf.org/arch/browse/mimi/">https://mailarchive.ietf.org/arch/browse/mimi/</a></span>.<a href="#section-note.1-2" class="pilcrow">¶</a></p>
<p id="section-note.1-3">Source for this draft and an issue tracker can be found at
    <span><a href="https://github.com/kkohbrok/mimi-metadata-minimalization">https://github.com/kkohbrok/mimi-metadata-minimalization</a></span>.<a href="#section-note.1-3" class="pilcrow">¶</a></p>
</section>
<div id="status-of-memo">
<section id="section-boilerplate.1">
        <h2 id="name-status-of-this-memo">
<a href="#name-status-of-this-memo" class="section-name selfRef">Status of This Memo</a>
        </h2>
<p id="section-boilerplate.1-1">
        This Internet-Draft is submitted in full conformance with the
        provisions of BCP 78 and BCP 79.<a href="#section-boilerplate.1-1" class="pilcrow">¶</a></p>
<p id="section-boilerplate.1-2">
        Internet-Drafts are working documents of the Internet Engineering Task
        Force (IETF). Note that other groups may also distribute working
        documents as Internet-Drafts. The list of current Internet-Drafts is
        at <span><a href="https://datatracker.ietf.org/drafts/current/">https://datatracker.ietf.org/drafts/current/</a></span>.<a href="#section-boilerplate.1-2" class="pilcrow">¶</a></p>
<p id="section-boilerplate.1-3">
        Internet-Drafts are draft documents valid for a maximum of six months
        and may be updated, replaced, or obsoleted by other documents at any
        time. It is inappropriate to use Internet-Drafts as reference
        material or to cite them other than as "work in progress."<a href="#section-boilerplate.1-3" class="pilcrow">¶</a></p>
<p id="section-boilerplate.1-4">
        This Internet-Draft will expire on 28 March 2025.<a href="#section-boilerplate.1-4" class="pilcrow">¶</a></p>
</section>
</div>
<div id="copyright">
<section id="section-boilerplate.2">
        <h2 id="name-copyright-notice">
<a href="#name-copyright-notice" class="section-name selfRef">Copyright Notice</a>
        </h2>
<p id="section-boilerplate.2-1">
            Copyright (c) 2024 IETF Trust and the persons identified as the
            document authors. All rights reserved.<a href="#section-boilerplate.2-1" class="pilcrow">¶</a></p>
<p id="section-boilerplate.2-2">
            This document is subject to BCP 78 and the IETF Trust's Legal
            Provisions Relating to IETF Documents
            (<span><a href="https://trustee.ietf.org/license-info">https://trustee.ietf.org/license-info</a></span>) in effect on the date of
            publication of this document. Please review these documents
            carefully, as they describe your rights and restrictions with
            respect to this document. Code Components extracted from this
            document must include Revised BSD License text as described in
            Section 4.e of the Trust Legal Provisions and are provided without
            warranty as described in the Revised BSD License.<a href="#section-boilerplate.2-2" class="pilcrow">¶</a></p>
</section>
</div>
<div id="toc">
<section id="section-toc.1">
        <a href="#" onclick="scroll(0,0)" class="toplink">▲</a><h2 id="name-table-of-contents">
<a href="#name-table-of-contents" class="section-name selfRef">Table of Contents</a>
        </h2>
<nav class="toc"><ul class="compact toc ulBare ulEmpty">
<li class="compact toc ulBare ulEmpty" id="section-toc.1-1.1">
            <p id="section-toc.1-1.1.1" class="keepWithNext"><a href="#section-1" class="auto internal xref">1</a>.  <a href="#name-introduction" class="internal xref">Introduction</a></p>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.2">
            <p id="section-toc.1-1.2.1" class="keepWithNext"><a href="#section-2" class="auto internal xref">2</a>.  <a href="#name-pseudonymization" class="internal xref">Pseudonymization</a></p>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.3">
            <p id="section-toc.1-1.3.1" class="keepWithNext"><a href="#section-3" class="auto internal xref">3</a>.  <a href="#name-pseudonymity-through-creden" class="internal xref">Pseudonymity through credential encryption</a></p>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.4">
            <p id="section-toc.1-1.4.1"><a href="#section-4" class="auto internal xref">4</a>.  <a href="#name-identity-link-key-managemen" class="internal xref">Identity link key management in rooms</a></p>
<ul class="compact toc ulBare ulEmpty">
<li class="compact toc ulBare ulEmpty" id="section-toc.1-1.4.2.1">
                <p id="section-toc.1-1.4.2.1.1"><a href="#section-4.1" class="auto internal xref">4.1</a>.  <a href="#name-add-flow" class="internal xref">Add flow</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.4.2.2">
                <p id="section-toc.1-1.4.2.2.1"><a href="#section-4.2" class="auto internal xref">4.2</a>.  <a href="#name-join-flow" class="internal xref">Join flow</a></p>
</li>
            </ul>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.5">
            <p id="section-toc.1-1.5.1"><a href="#section-5" class="auto internal xref">5</a>.  <a href="#name-connections" class="internal xref">Connections</a></p>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.6">
            <p id="section-toc.1-1.6.1"><a href="#section-6" class="auto internal xref">6</a>.  <a href="#name-user-to-user-pseudonymity" class="internal xref">User-to-user pseudonymity</a></p>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.7">
            <p id="section-toc.1-1.7.1"><a href="#section-7" class="auto internal xref">7</a>.  <a href="#name-keypackages" class="internal xref">KeyPackages</a></p>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.8">
            <p id="section-toc.1-1.8.1"><a href="#section-8" class="auto internal xref">8</a>.  <a href="#name-message-fanout" class="internal xref">Message Fanout</a></p>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.9">
            <p id="section-toc.1-1.9.1"><a href="#appendix-A" class="auto internal xref"></a><a href="#name-authors-addresses" class="internal xref">Authors' Addresses</a></p>
</li>
        </ul>
</nav>
</section>
</div>
<div id="introduction">
<section id="section-1">
      <h2 id="name-introduction">
<a href="#section-1" class="section-number selfRef">1. </a><a href="#name-introduction" class="section-name selfRef">Introduction</a>
      </h2>
<p id="section-1-1">Since the MIMI protocol uses MLS PublicMessages for Proposals and Commits, both
Hub and Provider can observe and track activities of clients both within an
individual group and across groups.<a href="#section-1-1" class="pilcrow">¶</a></p>
<p id="section-1-2">The goal of the scheme described in this document are as follows:<a href="#section-1-2" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-1-3.1">
          <p id="section-1-3.1.1">For a given client, prevent the Hub and all service providers from associating
the activity of the client with that client's identifier.<a href="#section-1-3.1.1" class="pilcrow">¶</a></p>
</li>
        <li class="normal" id="section-1-3.2">
          <p id="section-1-3.2.1">For a given client, prevent the Hub and all service providers except for the
client's service provider from associating the activity of that client in one
group from that in any other.<a href="#section-1-3.2.1" class="pilcrow">¶</a></p>
</li>
      </ul>
<p id="section-1-4">These propoerties are achieved withouth limiting the ability of the Hub to track
a group's group state and provider public group information to newly joining
clients.<a href="#section-1-4" class="pilcrow">¶</a></p>
<p id="section-1-5">However, the scheme comes with a few operative requirements and the following
general limitations:<a href="#section-1-5" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-1-6.1">
          <p id="section-1-6.1.1">There needs to be the notion of a "connection" between two users. Users that
are connected can link a pseudonym with a user's real identity and can
(selectively) allow others to do the same.<a href="#section-1-6.1.1" class="pilcrow">¶</a></p>
</li>
        <li class="normal" id="section-1-6.2">
          <p id="section-1-6.2.1">Only connected users can add one-another to groups.<a href="#section-1-6.2.1" class="pilcrow">¶</a></p>
</li>
        <li class="normal" id="section-1-6.3">
          <p id="section-1-6.3.1">Users that join a group need help of an existing group member in linking the
pseudonyms visible in the group to real user identities.<a href="#section-1-6.3.1" class="pilcrow">¶</a></p>
</li>
      </ul>
<p id="section-1-7">This document only contains a high-level description of the individual changes
required to achieve the goals detailed above.<a href="#section-1-7" class="pilcrow">¶</a></p>
</section>
</div>
<div id="pseudonymization">
<section id="section-2">
      <h2 id="name-pseudonymization">
<a href="#section-2" class="section-number selfRef">2. </a><a href="#name-pseudonymization" class="section-name selfRef">Pseudonymization</a>
      </h2>
<p id="section-2-1">The main mechanism to hide the user and client identifiers from the hub and
providers in the context of individual groups and use user-level and client-level
pseudonyms instead.<a href="#section-2-1" class="pilcrow">¶</a></p>
<p id="section-2-2">The purpose of the pseudonymization scheme described in this document is to
hide metadata from service providers with as little impact as possible on the
features provided by the base MIMI protocol. This means that by
default, User and client identifiers are still visible to (other) users and
their clients.<a href="#section-2-2" class="pilcrow">¶</a></p>
<p id="section-2-3">In addition, the pseudonymization scheme can also be used to hide a user's
identity from other users. See Section <a href="#user-to-user-pseudonymity" class="auto internal xref">Section 6</a> for more
details.<a href="#section-2-3" class="pilcrow">¶</a></p>
</section>
</div>
<div id="pseudonymity-through-credential-encryption">
<section id="section-3">
      <h2 id="name-pseudonymity-through-creden">
<a href="#section-3" class="section-number selfRef">3. </a><a href="#name-pseudonymity-through-creden" class="section-name selfRef">Pseudonymity through credential encryption</a>
      </h2>
<p id="section-3-1">Clients use PseudonymousCredentials to represent them in MIMI rooms to hide their
identities from providers<a href="#section-3-1" class="pilcrow">¶</a></p>
<div class="lang-tls sourcecode" id="section-3-2">
<pre>
struct {
  IdentifierUri client_pseudonym;
  IdentifierUri user_pseudonym;
  opaque signature_public_key;
  opaque identity_link_ciphertext&lt;V&gt;;
} PseudonymousCredential
</pre><a href="#section-3-2" class="pilcrow">¶</a>
</div>
<p id="section-3-3">PseudonymousCredentials don't contain a client's client
and user ID. Instead, they use two pseudonyms: a user pseudonym shared by all
other PseudonymousCredentials of the user's clients in a given room and a
client pseudonym unique for each PseudonymousCredential. Each pseudonym is an
IdentifierUri made up of a randomly generated UUID and the user's provider's
domain.<a href="#section-3-3" class="pilcrow">¶</a></p>
<div class="lang-tls sourcecode" id="section-3-4">
<pre>
struct {
  IdentifierUri client_pseudonym;
  IdentifierUri user_pseudonym;
  opaque signature_public_key;
} PseudonymousCredentialTBS

struct {
  /* SignWithLabel(., "PseudonymousCredentialTBS",
    PseudonymousCredentialTBS) */
  opaque pseudonymous_credential_signature&lt;V&gt;;
  Credential client_credential;
} IdentityLinkTBE
</pre><a href="#section-3-4" class="pilcrow">¶</a>
</div>
<p id="section-3-5">The <code>identity_link_ciphertext</code> is created by encrypting the IdentityLinkTBE,
which contains the client's real credential, as well as a signature over the
PseudonymousCredentialTBS using the client credential's signature key.<a href="#section-3-5" class="pilcrow">¶</a></p>
<p id="section-3-6">The <code>identity_link_key</code> used for encryption is unique per pseudonymous credential.
It is derived from the client's <code>connection_key</code>.<a href="#section-3-6" class="pilcrow">¶</a></p>
<div class="lang-tls sourcecode" id="section-3-7">
<pre>
identity_link_key = ExpandWithLabel(connection_key,
  "IdentityLinkKey", PseudonymousCredentialTBS, KDF.Nh)
</pre><a href="#section-3-7" class="pilcrow">¶</a>
</div>
<p id="section-3-8">See <a href="#connections" class="auto internal xref">Section 5</a> for more details on the <code>connection_key</code>.<a href="#section-3-8" class="pilcrow">¶</a></p>
<p id="section-3-9">Pseudonyms are specific to each room and client since the <code>identity_link_key</code> is
unique per pseudonymous credential and pseudonymous credentials are used in only
once (i.e. in one room).<a href="#section-3-9" class="pilcrow">¶</a></p>
</section>
</div>
<div id="identity-link-key-management-in-rooms">
<section id="section-4">
      <h2 id="name-identity-link-key-managemen">
<a href="#section-4" class="section-number selfRef">4. </a><a href="#name-identity-link-key-managemen" class="section-name selfRef">Identity link key management in rooms</a>
      </h2>
<p id="section-4-1">All clients in a room MUST be able to decrypt the <code>identity_link_ciphertext</code> of
all other clients in the room, except in the cases detailed in
<a href="#user-to-user-pseudonymity" class="auto internal xref">Section 6</a>.<a href="#section-4-1" class="pilcrow">¶</a></p>
<p id="section-4-2">TODO: The following scheme should be replaced by TreeWrap for FS and PCS. It's a
simple placeholder for now.<a href="#section-4-2" class="pilcrow">¶</a></p>
<p id="section-4-3">The hub holds encrypted copies of the <code>identity_link_key</code>s of all
clients in the room and updates them as clients get added, removed and updated.
The <code>identity_link_key</code>s are encrypted with the room's <code>identity_link_wrapper_key</code>.<a href="#section-4-3" class="pilcrow">¶</a></p>
<p id="section-4-4">The <code>identity_link_wrapper_key</code> is freshly generated by the room's creator and
does not change throughout the lifetime of the group.<a href="#section-4-4" class="pilcrow">¶</a></p>
<p id="section-4-5">The <code>identity_link_wrapper_key</code> is distributed to new participants as they join
the room.<a href="#section-4-5" class="pilcrow">¶</a></p>
<div id="add-flow">
<section id="section-4.1">
        <h3 id="name-add-flow">
<a href="#section-4.1" class="section-number selfRef">4.1. </a><a href="#name-add-flow" class="section-name selfRef">Add flow</a>
        </h3>
<p id="section-4.1-1">If a group member adds a new user, the adder MUST include a
IdentityLinkExtension in the Welcome's GroupInfoExtensions.<a href="#section-4.1-1" class="pilcrow">¶</a></p>
<div class="lang-tls sourcecode" id="section-4.1-2">
<pre>
struct {
  opaque identity_link_wrapper_key&lt;V&gt;;
} IdentityLinkExtension
</pre><a href="#section-4.1-2" class="pilcrow">¶</a>
</div>
<p id="section-4.1-3">The adder MUST also include the encrypted <code>identity_link_key</code> of all added users
in the AAD of the commit message. The order of the encrypted <code>identity_link_key</code>s
in the AAD MUST match the order of the Add proposals in the Commit message.<a href="#section-4.1-3" class="pilcrow">¶</a></p>
<p id="section-4.1-4">Note that this requires the adder to have a connection with each added user as
specified in <a href="#connections" class="auto internal xref">Section 5</a>.<a href="#section-4.1-4" class="pilcrow">¶</a></p>
<p id="section-4.1-5">TODO: Note here that the sender MUST use the SafeAAD as defined in the extension
doc.<a href="#section-4.1-5" class="pilcrow">¶</a></p>
<div class="lang-tls sourcecode" id="section-4.1-6">
<pre>
struct {
  opaque encrypted_identity_link_keys&lt;V&gt;;
} AddAAD
</pre><a href="#section-4.1-6" class="pilcrow">¶</a>
</div>
<p id="section-4.1-7">Existing group members can then decrypt the <code>identity_link_key</code>s to learn the
real identities of the added users.<a href="#section-4.1-7" class="pilcrow">¶</a></p>
<p id="section-4.1-8">When it receoves a Commit message, the hub adds the encrypted <code>identity_link_key</code>s to
the room's state.<a href="#section-4.1-8" class="pilcrow">¶</a></p>
<p id="section-4.1-9">Finally, the added user receiving the welcome can then obtain the encrypted
<code>identity_link_key</code>s from the hub and decrypt them using the
<code>identity_link_wrapper_key</code> from the extension and use the decrypted
<code>identity_link_key</code>s to decrypt the <code>identity_link_ciphertexts</code> of all other
clients in the room.<a href="#section-4.1-9" class="pilcrow">¶</a></p>
</section>
</div>
<div id="join-flow">
<section id="section-4.2">
        <h3 id="name-join-flow">
<a href="#section-4.2" class="section-number selfRef">4.2. </a><a href="#name-join-flow" class="section-name selfRef">Join flow</a>
        </h3>
<p id="section-4.2-1">Members joining a room through the join flow need to obtain the
<code>identity_link_wrapper_key</code> out of band. The key can be shared any other group
member.<a href="#section-4.2-1" class="pilcrow">¶</a></p>
<p id="section-4.2-2">TODO: When defining features such as join/invitation links the
<code>identity_link_wrapper_key</code> should be included in the link.<a href="#section-4.2-2" class="pilcrow">¶</a></p>
<p id="section-4.2-3">When joining the group, the joining client MUST include its own encrypted
<code>identity_link_key</code> in the AAD of the external commit message via the AddAAD
struct.<a href="#section-4.2-3" class="pilcrow">¶</a></p>
</section>
</div>
</section>
</div>
<div id="connections">
<section id="section-5">
      <h2 id="name-connections">
<a href="#section-5" class="section-number selfRef">5. </a><a href="#name-connections" class="section-name selfRef">Connections</a>
      </h2>
<p id="section-5-1">A connection is a mutually agreed-upon relation betwen two users. Users can
establish connections between one-another through the following process.<a href="#section-5-1" class="pilcrow">¶</a></p>
<p id="section-5-2">Let's call the initiator of the connection establishment Alice and the
responding user Bob.<a href="#section-5-2" class="pilcrow">¶</a></p>
<p id="section-5-3">At the time of registration with their local provider, Alice and Bob generate an
HPKE keypair and upload the public key (called the connection establishment
public key) to their respective providers. The providers make the keys available
to all other users without requiring authentication.<a href="#section-5-3" class="pilcrow">¶</a></p>
<p id="section-5-4">To hide Alice's identity from Bob's provider throughout the connection
establishment process, Alice obtains Bob's connection establishment public key
from Bob's provider.<a href="#section-5-4" class="pilcrow">¶</a></p>
<p id="section-5-5">Alice now creates a new conversation with her local provider as hub and adds
all of her clients to that conversation. She then compiles the following
information into a connection request:<a href="#section-5-5" class="pilcrow">¶</a></p>
<div class="lang-tls sourcecode" id="section-5-6">
<pre>
struct {
  Credential requester_client_credential;
  opaque connection_room_id&lt;V&gt;;
  opaque connection_room_identity_link_wrapper_key&lt;V&gt;;
  opaque requester_connection_key&lt;V&gt;;
  opaque connection_response_key&lt;V&gt;;
} ConnectionRequest
</pre><a href="#section-5-6" class="pilcrow">¶</a>
</div>
<p id="section-5-7">The <code>connection_response_key</code> is a fresh HPKE keypair that Alice generates when
she creates the connection request. It is later used by Bob to encrypt his own
<code>connection_key</code> if Bob chooses to accept the request.<a href="#section-5-7" class="pilcrow">¶</a></p>
<p id="section-5-8">TODO: The request will likely contain more information such as e.g. an authorization
token that allows Bob to fetch Alice's KeyPackages. Any such information must also
be included in the ConnectionResponse below.<a href="#section-5-8" class="pilcrow">¶</a></p>
<p id="section-5-9">Alice then encrypts the connection request using Bob's connection establishment
public key and sends it to Bob's provider.<a href="#section-5-9" class="pilcrow">¶</a></p>
<p id="section-5-10">Bob fetches the connection request from his provider and decrypts it using his
connection establishment key.<a href="#section-5-10" class="pilcrow">¶</a></p>
<p id="section-5-11">He can inspect Alice's <code>requester_client_credential</code> and decide whether to
accept the request.<a href="#section-5-11" class="pilcrow">¶</a></p>
<p id="section-5-12">If Bob accepts, he creates a connection response:<a href="#section-5-12" class="pilcrow">¶</a></p>
<div class="lang-tls sourcecode" id="section-5-13">
<pre>
struct {
  opaque responder_connection_key&lt;V&gt;;
} ConnectionResponse
</pre><a href="#section-5-13" class="pilcrow">¶</a>
</div>
<p id="section-5-14">Bob then follows the join flow for the room with the <code>connection_room_id</code>,
including the ConnectionResponse encrypted under the <code>connection_response_key</code>
in the join message's (i.e. the external commit's) AAD. As part of that
process, he obtains the encrypted <code>identity_link_key</code>s for Alice's clients and
verifies that they belong to the same user as the <code>requester_client_credential</code>
in the connection request.<a href="#section-5-14" class="pilcrow">¶</a></p>
<p id="section-5-15">Bob joining the room signals to Alice that Bob has accepted her connection
request. Alice can decrypt Bob's ConnectionResponse in the join message's AAD
using the connection response key she initially included in the connection
request.<a href="#section-5-15" class="pilcrow">¶</a></p>
<p id="section-5-16">Both Alice and Bob now share a room and can derive <code>identity_link_key</code>s for each
other's clients, which in turn allows them to add each other to rooms.<a href="#section-5-16" class="pilcrow">¶</a></p>
</section>
</div>
<div id="user-to-user-pseudonymity">
<section id="section-6">
      <h2 id="name-user-to-user-pseudonymity">
<a href="#section-6" class="section-number selfRef">6. </a><a href="#name-user-to-user-pseudonymity" class="section-name selfRef">User-to-user pseudonymity</a>
      </h2>
<p id="section-6-1">In some cases, users may want to communicate with each other without revealing
their real identities to one-another. Room policy can thus specify the extent
to which clients are required to provide <code>identity_link_key</code>s. For example,
<code>identity_link_key</code>s might not be allowed at all, or only admins are required to
provide <code>identity_link_key</code>s.<a href="#section-6-1" class="pilcrow">¶</a></p>
</section>
</div>
<div id="keypackages">
<section id="section-7">
      <h2 id="name-keypackages">
<a href="#section-7" class="section-number selfRef">7. </a><a href="#name-keypackages" class="section-name selfRef">KeyPackages</a>
      </h2>
<p id="section-7-1">The use of user and client pseudonyms requires some additional care when
generating and uploading KeyPackages.<a href="#section-7-1" class="pilcrow">¶</a></p>
<p id="section-7-2">The user and client pseudonyms in the PseudonymousCredential must be unique
across groups. For the client pseudonym to be unique across groups, clients can
generate it randomly for each KeyPackage.<a href="#section-7-2" class="pilcrow">¶</a></p>
<p id="section-7-3">However, to allow the hub to associate a set of leaves with a user, the user
pseudonym must be consistent across the leaves in that group. This means that
clients need to coordinate to provide KeyPackage sets, where each KeyPackage in
a set contains a consistent user pseudonym and no two sets contain the same
pseudonym. Each such set can be used in the context of one group.<a href="#section-7-3" class="pilcrow">¶</a></p>
<p id="section-7-4">A procedure for a client to upload KeyPackages could thus look as follows:<a href="#section-7-4" class="pilcrow">¶</a></p>
<ol start="1" type="1" class="normal type-1" id="section-7-5">
<li id="section-7-5.1">
          <p id="section-7-5.1.1">Check for which user pseudonyms other clients of the same user have uploaded
KeyPackages.<a href="#section-7-5.1.1" class="pilcrow">¶</a></p>
</li>
        <li id="section-7-5.2">
          <p id="section-7-5.2.1">Identify user pseudonyms for which the KeyPackage set is missing a KeyPackage
of this client.<a href="#section-7-5.2.1" class="pilcrow">¶</a></p>
</li>
        <li id="section-7-5.3">
          <p id="section-7-5.3.1">Generate and upload KeyPackages for those user pseudonyms.<a href="#section-7-5.3.1" class="pilcrow">¶</a></p>
</li>
        <li id="section-7-5.4">
          <p id="section-7-5.4.1">Upload as many KeyPackages as desired, thus starting new KeyPackage sets for
other clients to complete.<a href="#section-7-5.4.1" class="pilcrow">¶</a></p>
</li>
      </ol>
<p id="section-7-6">At least one KeyPackage set of each user must consist of last-resort
KeyPackages. If such a last-resort set is used more than once, the use of the
same user pseudonym allows the hub to learn that one user is active in two
particular groups. The re-use of such a set cannot be avoided entirely, but
users upload more than one set (and re-upload last-resort sets frequently) to
mitigate this at least to a certain degree.<a href="#section-7-6" class="pilcrow">¶</a></p>
<p id="section-7-7">When uploading KeyPackages, user generally upload KeyPackages to their provider
indexed by their connection token. To avoid leaking metadata to the user's own
provider, the upload must not be connected to the user's identity.<a href="#section-7-7" class="pilcrow">¶</a></p>
<p id="section-7-8">Users can then fetch KeyPackages of connected users from their respective
providers using the connected user's connection token.<a href="#section-7-8" class="pilcrow">¶</a></p>
</section>
</div>
<div id="message-fanout">
<section id="section-8">
      <h2 id="name-message-fanout">
<a href="#section-8" class="section-number selfRef">8. </a><a href="#name-message-fanout" class="section-name selfRef">Message Fanout</a>
      </h2>
<p id="section-8-1">This protocol assumes that clients have one or more queue IDs that their local
provider can use to route incoming messages to a place that the client can
access.<a href="#section-8-1" class="pilcrow">¶</a></p>
<p id="section-8-2">For each member of a given group, the member's queue ID is stored in a leaf node
extension s.t. the hub can forward that information to the client's local
provider upon fanout.<a href="#section-8-2" class="pilcrow">¶</a></p>
<p id="section-8-3">Since in most cases, there will only be a single queue for each client (as
opposed to one queue per group), the queue ID is encrypted using an HPKE key of
the client's provider.<a href="#section-8-3" class="pilcrow">¶</a></p>
<p id="section-8-4">When receiving the encrypted queue ID with the message fanout, the provider can
decrypt the queue ID and route the message to the correct queue.<a href="#section-8-4" class="pilcrow">¶</a></p>
</section>
</div>
<div id="authors-addresses">
<section id="appendix-A">
      <h2 id="name-authors-addresses">
<a href="#name-authors-addresses" class="section-name selfRef">Authors' Addresses</a>
      </h2>
<address class="vcard">
        <div dir="auto" class="left"><span class="fn nameRole">Konrad Kohbrok</span></div>
<div dir="auto" class="left"><span class="org">Phoenix R&amp;D</span></div>
<div class="email">
<span>Email:</span>
<a href="mailto:konrad.kohbrok@datashrine.de" class="email">konrad.kohbrok@datashrine.de</a>
</div>
</address>
<address class="vcard">
        <div dir="auto" class="left"><span class="fn nameRole">Raphael Robert</span></div>
<div dir="auto" class="left"><span class="org">Phoenix R&amp;D</span></div>
<div class="email">
<span>Email:</span>
<a href="mailto:ietf@raphaelrobert.com" class="email">ietf@raphaelrobert.com</a>
</div>
</address>
</section>
</div>
<script>const toc = document.getElementById("toc");
toc.querySelector("h2").addEventListener("click", e => {
  toc.classList.toggle("active");
});
toc.querySelector("nav").addEventListener("click", e => {
  toc.classList.remove("active");
});
</script>
</body>
</html>
